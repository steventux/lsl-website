
(function($,undefined){"use strict";$.ajaxPrefilter(function(options,origOptions,jqXHR){if(options.iframe){return"iframe";}});$.ajaxTransport("iframe",function(options,origOptions,jqXHR){var form=null,iframe=null,name="iframe-"+$.now(),files=$(options.files).filter(":file:enabled"),markers=null;function cleanUp(){markers.replaceWith(function(idx){return files.get(idx);});form.remove();iframe.attr("src","javascript:false;").remove();}
options.dataTypes.shift();if(files.length){form=$("<form enctype='multipart/form-data' method='post'></form>").hide().attr({action:options.url,target:name});if(typeof(options.data)==="string"&&options.data.length>0){$.error("data must not be serialized");}
$.each(options.data||{},function(name,value){if($.isPlainObject(value)){name=value.name;value=value.value;}
$("<input type='hidden'>").attr({name:name,value:value}).appendTo(form);});$("<input type='hidden' value='IFrame' name='X-Requested-With'>").appendTo(form);markers=files.after(function(idx){return $(this).clone().prop("disabled",true);}).next();files.appendTo(form);return{send:function(headers,completeCallback){iframe=$("<iframe src='javascript:false;' name='"+name+"' style='display:none'></iframe>");iframe.on("load",function(){iframe.off("load").on("load",function(){var doc=this.contentWindow?this.contentWindow.document:(this.contentDocument?this.contentDocument:this.document),root=doc.documentElement?doc.documentElement:doc.body,textarea=root.getElementsByTagName("textarea")[0],type=textarea?textarea.getAttribute("data-type"):null,content={html:root.innerHTML,text:type?textarea.value:root?(root.textContent||root.innerText):null},status=200,response;cleanUp();try{response=JSON.parse(content.text);status=response.error||200;delete response.error;content.text=JSON.stringify(response);}catch(e){}
completeCallback(status,status==200?"success":"error",content,type?("Content-Type: "+type):null);});form[0].submit();});$("body").append(form,iframe);},abort:function(){if(iframe!==null){iframe.off("load").attr("src","javascript:false;");cleanUp();}}};}});})(jQuery);
(function(window){var Backbone=window.Backbone,_=window._,$=window.$,file_upload={Views:{}};file_upload.Model=Backbone.Model.extend({});file_upload.Collection=Backbone.Collection.extend({model:file_upload.Model,initialize:function(options){options=options||{}
this.url=options.url||'/files';return this;}});file_upload.Views.FileInput=Backbone.View.extend({initialize:function(options){_.bindAll(this,'fail','uploading','done');options=options||{};this.url=options.url||'/upload';this.data=options.data||{};this._name=options.name||'files[]';this._multiple=options.multiple||true;this._enabled=options.enabled||true;return this;},tagName:'input',events:{'change':'change'},render:function(){this.$el.attr('type','file').attr('name',this._name);if(this._multiple){this.$el.attr('multiple',true);}
if(!this._enabled){this.$el.attr('disabled','disabled');}
this.$input=this.$el;return this;},enable:function(enable){if(this._enabled!=enable){this._enabled=enable;if(enable){this.$input.removeAttr('disabled');}else{this.$input.attr('disabled','disabled');}
this.trigger('enabled',enable);}},toggle_enable:function(){this.enable(!this._enabled);},change:function(ev){if(this._enabled){$.ajax(this.url,{files:this.$input,iframe:true,dataType:'json',data:this.data}).always(this.uploading).done(this.done).fail(this.fail);}},done:function(data,textStatus,jqXHR){this.collection.add(data);this.trigger('done',this.collection,data,textStatus,jqXHR);},fail:function(jqXHR){this.trigger('fail',JSON.parse(jqXHR.responseText),jqXHR);},uploading:function(data,textStatus,jqXHR){this.trigger('uploading');this.$input.val('');}});file_upload.Views.LabelFileInput=file_upload.Views.FileInput.extend({template:'<%=text%><input type=file name=<%=name%> <%= enabled ? "" : "disabled=disabled" %> <%= multiple ? "multiple" : ""%> />',initialize:function(options){options=options||{};this._text=options.text||'Upload File';this.template=options.template||_.template(this.template);return file_upload.Views.FileInput.prototype.initialize.call(this,options);},tagName:'label',className:'file-upload',events:{'change input[type=file]':'change'},serialize:function(){return{text:this._text,name:this._name,multiple:this._multiple,enabled:this._enabled};},render:function(){this.$el.html(this.template(this.serialize()));this.$input=this.$('input[type=file]');if(!this._enabled){this.$el.addClass('disabled');}
return this;},enable:function(enable){if(this._enabled!=enable){this.$el[enable?'removeClass':'addClass']('disabled');return file_upload.Views.FileInput.prototype.enable.call(this,enable);}}});Backbone.FileUpload=file_upload;})(this);